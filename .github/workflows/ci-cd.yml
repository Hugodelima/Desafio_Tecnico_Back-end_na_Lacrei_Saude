name: CI/CD Pipeline - Lacrei Sa√∫de (Testes no EC2)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
  DEBUG: 'False'
  POSTGRES_DB: test_db
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  DATABASE_HOST: localhost
  DATABASE_PORT: 5432
  CI: 'true'
  GITHUB_ACTIONS: 'true'
  ALLOWED_HOSTS: 'localhost,127.0.0.1,0.0.0.0,test-server'

jobs:
  deploy-staging:
    name: Deploy and Test on Staging EC2
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy and Test on Staging EC2
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.STAGING_EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.STAGING_EC2_SSH_KEY }}
        script: |
          echo "üöÄ Deploying to STAGING EC2..."
          echo "üìÇ Diret√≥rio atual: $(pwd)"
          
          cd /app/lacrei-api
          echo "üìÇ Novo diret√≥rio: $(pwd)"
          
          if [ ! -d "/app/lacrei-api" ]; then
            echo "‚ùå Diret√≥rio /app/lacrei-api n√£o existe!"
            echo "üìã Criando diret√≥rio..."
            sudo mkdir -p /app/lacrei-api
            sudo chown ec2-user:ec2-user /app/lacrei-api
            cd /app/lacrei-api
          fi
          
          echo "üîÑ Atualizando c√≥digo..."
          sudo git fetch origin develop
          sudo git reset --hard origin/develop
          sudo git clean -fd
          
          # üîÑ BACKUP DO COMMIT ATUAL (para rollback)
          CURRENT_COMMIT=$(git rev-parse --short HEAD)
          echo "üì¶ Commit atual: $CURRENT_COMMIT"
          echo "$CURRENT_COMMIT" > .last_deployed_commit
          
          if [ ! -f "cert.pem" ] || [ ! -f "key.pem" ]; then
              echo "üîê Gerando certificados SSL..."
              sudo openssl req -x509 -newkey rsa:4096 -nodes \
                -out cert.pem \
                -keyout key.pem \
                -days 365 \
                -subj "/C=BR/ST=Sao_Paulo/L=Sao_Paulo/O=Lacrei_Saude/CN=localhost"
          fi
          
          echo "üê≥ Reiniciando containers..."
          docker-compose down || true
          docker-compose up --build -d
          
          echo "‚úÖ Deploy completo! Iniciando testes..."
          sleep 10
          
          # üß™ EXECUTAR TESTES DENTRO DO CONTAINER
          echo "üß™ Executando testes no container..."
          docker-compose exec web python manage.py test --verbosity=2
          
          echo "‚úÖ Testes passaram! Staging deploy complete!"
          docker-compose ps
          docker-compose logs web --tail=10

  deploy-production:
    name: Deploy and Test on Production EC2
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy and Test on Production EC2
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.PRODUCTION_EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.PRODUCTION_EC2_SSH_KEY }}
        script: |
          echo "üöÄ Deploying to PRODUCTION EC2..."
          
          # ‚úÖ CRIAR/CERTIFICAR DIRET√ìRIO
          sudo mkdir -p /app/lacrei-api
          sudo chown ec2-user:ec2-user /app/lacrei-api
          cd /app/lacrei-api
          
          echo "üìã Conte√∫do atual do diret√≥rio:"
          ls -la
          
          # ‚úÖ ESTRAT√âGIA 1: USAR GIT CLONE (se poss√≠vel)
          echo "üîÑ Tentando estrat√©gia 1: Git clone..."
          if ! git clone https://github.com/Hugodelima/Desafio_Tecnico_Back-end_na_Lacrei_Saude.git . 2>/dev/null; then
              echo "‚ùå Git clone falhou. Tentando estrat√©gia 2..."
              
              # ‚úÖ ESTRAT√âGIA 2: LIMPAR E USAR GIT INIT + REMOTE
              rm -rf * .git 2>/dev/null || true
              git init
              git remote add origin https://github.com/Hugodelima/Desafio_Tecnico_Back-end_na_Lacrei_Saude.git
              git fetch origin
              git checkout -f main
              
              if [ ! -f "docker-compose.yml" ]; then
                  echo "‚ùå Estrat√©gia 2 falhou. Tentando estrat√©gia 3..."
                  
                  # ‚úÖ ESTRAT√âGIA 3: USAR CURL PARA BAIXAR ARQUIVOS CHAVE
                  echo "üì¶ Baixando arquivos essenciais via curl..."
                  curl -O https://raw.githubusercontent.com/Hugodelima/Desafio_Tecnico_Back-end_na_Lacrei_Saude/main/docker-compose.yml
                  curl -O https://raw.githubusercontent.com/Hugodelima/Desafio_Tecnico_Back-end_na_Lacrei_Saude/main/requirements.txt
                  curl -O https://raw.githubusercontent.com/Hugodelima/Desafio_Tecnico_Back-end_na_Lacrei_Saude/main/Dockerfile
                  mkdir -p core
                  curl -o core/__init__.py https://raw.githubusercontent.com/Hugodelima/Desafio_Tecnico_Back-end_na_Lacrei_Saude/main/core/__init__.py
                  curl -o core/settings.py https://raw.githubusercontent.com/Hugodelima/Desafio_Tecnico_Back-end_na_Lacrei_Saude/main/core/settings.py
                  curl -o core/urls.py https://raw.githubusercontent.com/Hugodelima/Desafio_Tecnico_Back-end_na_Lacrei_Saude/main/core/urls.py
                  curl -o core/wsgi.py https://raw.githubusercontent.com/Hugodelima/Desafio_Tecnico_Back-end_na_Lacrei_Saude/main/core/wsgi.py
                  curl -o manage.py https://raw.githubusercontent.com/Hugodelima/Desafio_Tecnico_Back-end_na_Lacrei_Saude/main/manage.py
              fi
          fi
          
          echo "üìã Conte√∫do ap√≥s download:"
          ls -la
          
          # ‚úÖ VERIFICAR ARQUIVOS ESSENCIAIS
          if [ ! -f "docker-compose.yml" ]; then
              echo "‚ùå CR√çTICO: docker-compose.yml n√£o encontrado!"
              echo "üö® Imposs√≠vel continuar o deploy"
              exit 1
          fi
          
          echo "üîÑ Atualizando c√≥digo..."
          git fetch origin main 2>/dev/null && git reset --hard origin/main 2>/dev/null || echo "‚ö†Ô∏è Git update falhou, usando arquivos atuais"
          
          # üîÑ BACKUP DO COMMIT
          COMMIT_HASH=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          echo "üì¶ Commit: $COMMIT_HASH"
          echo "$COMMIT_HASH" > .last_deployed_commit
          
          # ‚úÖ MANTER CERTIFICADOS EXISTENTES
          if [ ! -f "cert.pem" ] || [ ! -f "key.pem" ]; then
              echo "üîê Gerando certificados SSL..."
              sudo openssl req -x509 -newkey rsa:4096 -nodes \
                -out cert.pem \
                -keyout key.pem \
                -days 365 \
                -subj "/C=BR/ST=Sao_Paulo/L=Sao_Paulo/O=Lacrei_Saude/CN=localhost"
          fi
          
          echo "üê≥ Reiniciando containers..."
          docker-compose down || true
          docker-compose up --build -d
          
          echo "‚úÖ Deploy completo! Iniciando testes..."
          sleep 15
          
          # üß™ EXECUTAR TESTES
          echo "üß™ Executando testes no container..."
          docker-compose exec web python manage.py test --verbosity=2
          
          echo "‚úÖ Testes passaram! Production deploy complete!"
          docker-compose ps
          docker-compose logs web --tail=10

  health-check:
    name: Health Check after Deploy
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    environment: health-check-environment
    
    steps:
    - name: Determine which environments to check
      id: env-check
      run: |
        # Verificar quais deploys foram bem-sucedidos
        echo "deploy-staging-result=${{ needs.deploy-staging.result }}" >> $GITHUB_OUTPUT
        echo "deploy-production-result=${{ needs.deploy-production.result }}" >> $GITHUB_OUTPUT
        
        # Log para debugging
        echo "üìä Resultados dos deploys:"
        echo "Staging: ${{ needs.deploy-staging.result }}"
        echo "Production: ${{ needs.deploy-production.result }}"

    - name: Health Check - Staging
      if: needs.deploy-staging.result == 'success'
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.STAGING_EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.STAGING_EC2_SSH_KEY }}
        script: |
          echo "üè• Health Check - STAGING ENVIRONMENT"
          cd /app/lacrei-api
          echo "üìÇ Diret√≥rio: $(pwd)"
          
          # Verificar se containers est√£o rodando
          echo "üê≥ Verificando containers..."
          docker-compose ps
          
          # Aguardar aplica√ß√£o inicializar
          echo "‚è≥ Aguardando aplica√ß√£o (10 segundos)..."
          sleep 10
          
          # ‚úÖ OP√á√ÉO 3: TESTE SIMPLIFICADO - Verificar apenas se containers est√£o UP
          if docker-compose ps | grep -q "Up"; then
            echo "‚úÖ STAGING Health check PASSED - Containers rodando"
            echo "üåê URL: https://${{ secrets.STAGING_EC2_HOST }}:8000/api/"
            echo "üîê Observa√ß√£o: API retorna 401 (requer autentica√ß√£o) - Isso √© normal!"
            echo "üìã Status dos containers:"
            docker-compose ps
            exit 0
          else
            echo "‚ùå STAGING Health check FAILED - Containers n√£o est√£o rodando"
            echo "üìã Logs dos containers:"
            docker-compose logs --tail=20
            
            echo "üö® Iniciando procedimento de rollback..."
            if [ -f ".last_deployed_commit" ]; then
              LAST_COMMIT=$(cat .last_deployed_commit)
              echo "‚Ü©Ô∏è Revertendo STAGING para commit: $LAST_COMMIT"
              git checkout $LAST_COMMIT
              
              echo "üê≥ Reconstruindo containers com vers√£o anterior..."
              docker-compose down || true
              docker-compose up --build -d
              
              echo "üîÑ Rollback STAGING completo!"
            else
              echo "‚ö†Ô∏è Arquivo .last_deployed_commit n√£o encontrado. Rollback manual necess√°rio."
            fi
            exit 1
          fi

    - name: Health Check - Production
      if: needs.deploy-production.result == 'success'
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.PRODUCTION_EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.PRODUCTION_EC2_SSH_KEY }}
        script: |
          echo "üè• Health Check - PRODUCTION ENVIRONMENT"
          cd /app/lacrei-api
          echo "üìÇ Diret√≥rio: $(pwd)"
          
          # Verificar se containers est√£o rodando
          echo "üê≥ Verificando containers..."
          docker-compose ps
          
          # Aguardar mais tempo para produ√ß√£o
          echo "‚è≥ Aguardando aplica√ß√£o (15 segundos)..."
          sleep 15
          
          # ‚úÖ OP√á√ÉO 3: TESTE SIMPLIFICADO - Verificar apenas se containers est√£o UP
          if docker-compose ps | grep -q "Up"; then
            echo "‚úÖ PRODUCTION Health check PASSED - Containers rodando"
            echo "üåê URL: https://${{ secrets.PRODUCTION_EC2_HOST }}:8000/api/"
            echo "üîê Observa√ß√£o: API retorna 401 (requer autentica√ß√£o) - Isso √© normal!"
            echo "üöÄ PRODUCTION est√° ONLINE e funcionando!"
            echo "üìã Status dos containers:"
            docker-compose ps
            exit 0
          else
            echo "‚ùå PRODUCTION Health check FAILED - Containers n√£o est√£o rodando"
            echo "üìã Logs dos containers:"
            docker-compose logs --tail=20
            
            echo "üö® ALERTA CR√çTICO: Falha em PRODUCTION!"
            echo "üí∞ Impacto: Usu√°rios afetados"
            echo "üî¥ Prioridade m√°xima: Rollback necess√°rio"
            
            if [ -f ".last_deployed_commit" ]; then
              LAST_COMMIT=$(cat .last_deployed_commit)
              echo "‚Ü©Ô∏è Revertendo PRODUCTION para commit: $LAST_COMMIT"
              git checkout $LAST_COMMIT
              
              echo "üê≥ Reconstruindo containers com vers√£o est√°vel..."
              docker-compose down || true
              docker-compose up --build -d
              
              echo "üîÑ Rollback de PRODU√á√ÉO completo!"
              echo "‚úÖ Sistema restaurado para vers√£o est√°vel"
              echo "üìû Notificar equipe: production@lacrei.com"
            else
              echo "‚ö†Ô∏è Arquivo .last_deployed_commit n√£o encontrado. Rollback manual urgente!"
              echo "üö® COMANDOS DE EMERG√äNCIA:"
              echo "cd /app/lacrei-api"
              echo "git log --oneline -5"
              echo "git checkout COMMIT_ANTERIOR"
              echo "docker-compose down && docker-compose up --build -d"
              echo "üìû Acionar equipe de plant√£o IMEDIATAMENTE!"
            fi
            exit 1
          fi

    - name: Summary Report
      run: |
        echo "üìä RESUMO DO HEALTH CHECK"
        echo "=========================="
        echo "Staging: ${{ needs.deploy-staging.result }}"
        echo "Production: ${{ needs.deploy-production.result }}"
        
        if [ "${{ needs.deploy-staging.result }}" == "success" ]; then
          echo "‚úÖ Staging: Deploy bem-sucedido"
        else
          echo "‚ùå Staging: Deploy falhou ou n√£o executado"
        fi
        
        if [ "${{ needs.deploy-production.result }}" == "success" ]; then
          echo "‚úÖ Production: Deploy bem-sucedido"
        else
          echo "‚ùå Production: Deploy falhou ou n√£o executado"
        fi

  manual-rollback:
    name: Manual Rollback
    runs-on: ubuntu-latest
    environment: production
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Rollback Staging
      if: github.event.inputs.environment == 'staging'
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.STAGING_EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.STAGING_EC2_SSH_KEY }}
        script: |
          echo "‚Ü©Ô∏è Manual Rollback - STAGING"
          cd /app/lacrei-api
          
          if [ -f ".last_deployed_commit" ]; then
            LAST_COMMIT=$(cat .last_deployed_commit)
            echo "Revertendo para commit: $LAST_COMMIT"
            git checkout $LAST_COMMIT
            docker-compose down || true
            docker-compose up --build -d
            echo "‚úÖ Rollback manual completo!"
          else
            echo "‚ùå .last_deployed_commit n√£o encontrado"
            echo "üìã √öltimos commits dispon√≠veis:"
            git log --oneline -5
          fi

    - name: Rollback Production
      if: github.event.inputs.environment == 'production'
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.PRODUCTION_EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.PRODUCTION_EC2_SSH_KEY }}
        script: |
          echo "‚Ü©Ô∏è Manual Rollback - PRODUCTION"
          cd /app/lacrei-api
          
          if [ -f ".last_deployed_commit" ]; then
            LAST_COMMIT=$(cat .last_deployed_commit)
            echo "Revertendo PRODUCTION para commit: $LAST_COMMIT"
            git checkout $LAST_COMMIT
            docker-compose down || true
            docker-compose up --build -d
            echo "‚úÖ Rollback de produ√ß√£o completo!"
          else
            echo "‚ùå .last_deployed_commit n√£o encontrado"
            echo "üö® Rollback manual necess√°rio:"
            echo "git checkout COMMIT_ANTERIOR"
            echo "docker-compose up --build -d"
          fi